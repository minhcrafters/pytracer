TODO:
- write more tests
- make sure the gpu code has full feature parity
